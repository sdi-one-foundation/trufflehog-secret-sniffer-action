name: 'Secret Sniffer - TruffleHog'
description: 'Github action runs TruffleHog to detect secrets in the repository. If secrets are found, it will fail the action and notify the team via email.'
inputs:
  ses-username:
    description: 'Username for the AWS SES service to send email alerts'
    required: true
  ses-password:
    description: 'Password for the AWS SES service to send email alerts'
    required: true
runs:
  using: "composite"
  steps:
    - shell: bash
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          echo "depth=$(($(jq length <<< '${{ toJson(github.event.commits) }}') + 2))" >> $GITHUB_ENV
          echo "branch=${{ github.ref_name }}" >> $GITHUB_ENV
        fi
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "depth=$((${{ github.event.pull_request.commits }}+2))" >> $GITHUB_ENV
          echo "branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
        fi

    - uses: actions/checkout@v3
      with:
        ref: ${{env.branch}}
        fetch-depth: ${{env.depth}}

    # Use the official TruffleHog action
    - uses: trufflesecurity/trufflehog@main
      id: trufflehog
      with:
        base: ""
        head: ${{ github.ref_name }}
        extra_args: --results=verified,unknown
      continue-on-error: true

    - name: Capture TruffleHog output
      shell: bash
      run: |
        if [ "${{ steps.trufflehog.outcome }}" == "failure" ]; then
          echo "TRUFFLEHOG_FOUND_SECRETS=true" >> $GITHUB_ENV

          # Create output directory
          mkdir -p trufflehog_output

          # Save the TruffleHog output to a temporary file
          echo "${{ steps.trufflehog.outputs.result }}" > trufflehog_temp.txt

          # The TruffleHog action doesn't provide structured output we can access directly
          # So we'll use the logs directly from the current process
          # Run TruffleHog again to get detailed output
          echo "Running TruffleHog to get detailed output..."
          docker run --rm -v "$(pwd):/pwd" -w /pwd trufflesecurity/trufflehog:latest git file:///pwd --json > trufflehog_raw_output.txt || true

          # Check if we got any output
          if [ -s trufflehog_raw_output.txt ]; then
            echo "Processing detailed TruffleHog output..."

            # Convert line-delimited JSON to array
            echo "[" > trufflehog_array.json
            cat trufflehog_raw_output.txt | grep -v "^{\"level\"" | grep -v "finished scanning" | tr '\n' ',' | sed 's/,$//' >> trufflehog_array.json
            echo "]" >> trufflehog_array.json

            # Process each finding to extract file and line information
            jq 'map(select(.SourceMetadata.Data.Git.file != null) | {
                "detection_time": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
                "repository": "${{ github.repository }}",
                "source": "TruffleHog GitHub Action",
                "file": .SourceMetadata.Data.Git.file,
                "line": .SourceMetadata.Data.Git.line,
                "detector_type": .DetectorName,
                "message": "A secret was detected in this repository. For security reasons, the actual secret is not displayed.",
                "recommendation": "Review this file for any sensitive information such as API keys, passwords, or private tokens."
              })' trufflehog_array.json > trufflehog_output.json
          fi

          # If processing failed or no detailed output, create a generic message
          if [ ! -s trufflehog_output.json ] || [ "$(cat trufflehog_output.json)" = "[]" ]; then
            echo '[{"detection_time":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","repository":"${{ github.repository }}","source":"TruffleHog GitHub Action","message":"Secrets were detected in this repository. For security reasons, detailed information about the secrets is not displayed here. Please review the GitHub Actions log for more details.","recommendation":"Review recent changes for any sensitive information such as API keys, passwords, or private tokens."}]' > trufflehog_output.json
          fi
        else
          echo "No secrets found by TruffleHog"
        fi

    - name: Set event type
      if: env.TRUFFLEHOG_FOUND_SECRETS == 'true'
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "EVENT_TYPE=Pull Request" >> $GITHUB_ENV
          echo "EVENT_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV

          # Create a list item for PR (only shown for pull requests)
          PR_LIST_ITEM='<li><a href="${{ github.event.pull_request.html_url }}">Pull Request #${{ github.event.pull_request.number }}</a></li>'

          echo "PR_LIST_ITEM<<EOF" >> $GITHUB_ENV
          echo "$PR_LIST_ITEM" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          echo "EVENT_TYPE=Push to ${{ github.ref_name }} branch" >> $GITHUB_ENV
          echo "EVENT_URL=${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}" >> $GITHUB_ENV
          echo "PR_LIST_ITEM=" >> $GITHUB_ENV
        fi

    - name: Post findings to PR
      if: env.TRUFFLEHOG_FOUND_SECRETS == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{ github.token }}
        script: |
          const fs = require('fs');
          let findings = [];

          try {
            const outputContent = fs.readFileSync('trufflehog_output.json', 'utf8');
            findings = JSON.parse(outputContent);
          } catch (error) {
            console.error("Error processing TruffleHog output:", error);
            findings = [{
              message: "Error processing TruffleHog output, but secrets were detected."
            }];
          }

          // Add findings to environment variable for email notification
          const findingsJSON = JSON.stringify(findings, null, 2);
          core.exportVariable('TRUFFLEHOG_FINDINGS', findingsJSON);

          // Build a table of findings if we have detailed information
          let secretsTable = '';
          if (findings.length > 0 && findings[0].file) {
            secretsTable = `
          | File | Line | Type |
          |------|------|------|
          ${findings.map(f => `| \`${f.file}\` | ${f.line || 'N/A'} | ${f.detector_type || 'Unknown'} |`).join('\n')}
          `;
          }

          const commentBody = `## ‚ö†Ô∏è Security Alert: Secrets Detected by TruffleHog ‚ö†Ô∏è
          This pull request has been scanned for secrets using TruffleHog, and sensitive information has been detected. Please review the findings below and take appropriate action to secure your repository.

          TruffleHog has detected secrets in this pull request. Please review and remove any sensitive information.
          ${secretsTable}

          <details>
          <summary>Details (click to expand)</summary>

          \`\`\`json
          ${JSON.stringify(findings, null, 2)}
          \`\`\`
          </details>

          **Important:** Committing secrets to a repository poses significant security risks. Please remove these secrets and consider them compromised.`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

    - name: Send mail
      if: env.TRUFFLEHOG_FOUND_SECRETS == 'true'
      uses: dawidd6/action-send-mail@v5
      with:
        server_address: email-smtp.us-east-1.amazonaws.com
        server_port: 465
        secure: true
        username: ${{inputs.ses-username}}
        password: ${{inputs.ses-password}}
        subject: Secrets Found in ${{github.repository}} repository
        to: alerts+foundation@one.singledigits.com
        from: '"Foundation Alerts" <alerts+foundation@one.singledigits.com>'
        html_body: |
          <!DOCTYPE html>
          <html>
          <head>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                color: #333;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
              }
              .header {
                background-color: #D32F2F;
                color: white;
                padding: 20px;
                border-radius: 5px 5px 0 0;
                margin-bottom: 0;
              }
              h1, h2, h3 {
                margin-top: 0;
              }
              .content {
                background-color: #f9f9f9;
                border: 1px solid #ddd;
                border-top: none;
                padding: 20px;
                border-radius: 0 0 5px 5px;
              }
              .alert {
                background-color: #FFF3E0;
                border-left: 4px solid #FF9800;
                padding: 15px;
                margin-bottom: 20px;
              }
              .button {
                display: inline-block;
                background-color: #f1f1f1;
                color: #0366d6;
                padding: 8px 16px;
                text-decoration: none;
                border-radius: 20px;
                margin-right: 8px;
                margin-bottom: 8px;
                border: 1px solid #e1e4e8;
                font-size: 14px;
                transition: background-color 0.2s;
              }
              .button:hover {
                background-color: #e6f1ff;
                border-color: #c8e1ff;
              }
              .button.warning {
                background-color: #fff1f0;
                color: #d73a49;
                border-color: #f9d0c4;
              }
              .button.warning:hover {
                background-color: #ffdce0;
                border-color: #f9c2c2;
              }
              .link-list {
                margin-bottom: 20px;
                padding-left: 20px;
              }
              .link-list li {
                margin-bottom: 8px;
              }
              .link-list a {
                color: #0366d6;
                text-decoration: underline;
                font-weight: 500;
              }
              .link-list a:hover {
                text-decoration: none;
              }
              pre {
                background-color: #f1f1f1;
                padding: 15px;
                border-radius: 4px;
                overflow-x: auto;
                border: 1px solid #ddd;
                font-family: monospace;
                font-size: 13px;
              }
              .emoji {
                font-size: 20px;
                vertical-align: middle;
                margin-right: 8px;
              }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>‚ö†Ô∏è Security Alert: Secrets Detected</h1>
            </div>
            <div class="content">
              <div class="alert">
                <p><strong>Secrets have been detected in the ${{github.repository}} repository.</strong></p>
                <p><strong>Event Type:</strong> ${{ env.EVENT_TYPE }}</p>
                <p>Please investigate and remediate immediately. Exposed secrets pose a significant security risk.</p>
              </div>

              <h3>üîó Important Links</h3>
              <ol class="link-list">
                <li>
                  <a href="${{ github.server_url }}/${{ github.repository }}">
                    Repository
                  </a>
                </li>
                <li>
                  <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                    GitHub Action Run
                  </a>
                </li>
                ${{ env.PR_LIST_ITEM }}
              </ol>

              <h3>üîç Detection Details</h3>
              <pre>${{ env.TRUFFLEHOG_FINDINGS }}</pre>

              <hr>
              <p><em>This is an automated security alert from the SingleDigits Foundation Team.</em></p>
              <p><small>Please do not reply to this email. For assistance, contact the security team.</small></p>
            </div>
          </body>
          </html>
        ignore_cert: true
        convert_markdown: true
        priority: high
        nodemailerlog: true
        nodemailerdebug: true

    - name: Scan Results Status
      if: steps.trufflehog.outcome == 'failure'
      run: exit 1
      shell: bash
